---
title: 'Множественная регрессия'
date: 'July, 5-6, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
# Регрессия при гомоскедастичных ошибках

```{r}
library(tidyverse) # обработка данных, графики...
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(broom) # метла превращает результаты оценивания моделей в таблички
library(GGally) # больше готовых графиков
library(sjPlot) # ещё больше графиков
library(lmtest) # диагностика линейных моделей
library(Ecdat) # много-много разных наборов данных
library(sjstats) # удобные мелкие функции для работы с моделями
library(sandwich) # оценка Var для гетероскедастичности
library(AER) # работа с инструментальными переменными
```

Возьмём набор данных о площади квартиры и финаансовом положении респондентов, подготовленный в формате sav

Загрузим данные и посмотрим на описательные статистики.

Установим в качестве текущей папки ту папку, где лежит данный `.Rmd`-файл:
`Session` — `Set working directory` — `To source file location`.


```{r}
ob <- import('C:/Users/ASUS/Desktop/r_course/data/obsl.sav')
glimpse(ob)
head(ob)
tail(ob)

```
Переменные
			
1	MEST	Тип населенного пункта (1-городской, 2- сельский) -	качественная
2	CHLICN	Число наличных лиц в домохозяйстве -	количественная
3	DOXODSN	Денежный доход	 - количественная
4	DOXODN	Среднедушевой доход	- количественная
5	POTRAS	Потребительские расходы	 - количественная
6	PROD	Расходы на покупку продуктов питания -	количественная
7	NEPROD	Непродовольственные расходы	 - количественная
8	USLUG	Расходы на оплату услуг	- количественная
9	NALOG	Налоги, сборы, платежи -	количественная
10	OBPL	Общая площадь квартиры	- количественная
11	RPC	Наличие персонального компьютера (1-да, 0 – нет) -	качественная
12	RAVT	Наличие автомобиля 	 - количественная
13	DOSINT	Доступ в интернет (1-да, 2-нет)	 - качественная
14	FINPOL	Финансовое положение  (-7 – затрудняюсь ответить, 1- не хватает на еду, 2 – на еду хватает, но на одежду нет, 3 – на еду и одежду хватает, но не хватает на оплату коммунальных платежей, 4- можем позволить все необходимое, 5 – средств достаточно)	- Порядковая (качественная)

Целевая переменная — OBPL	Общая площадь квартиры.
Переменная FINPOL имеет 6 градации (-7 – затрудняюсь ответить, 1- не хватает на еду, 2 – на еду хватает, но на одежду нет, 3 – на еду и одежду хватает, но не хватает на оплату коммунальных платежей, 4- можем позволить все необходимое, 5 – средств достаточно)
Переменная Наличие доступа в Интернет (DOSINT), принимает два значения, '1' (да), '2' (нет).

Observations: 1,396
Variables: 14

Вернём факторным переменным положенный статус!

```{r}
ob_fct <- ob %>%
  mutate_at(vars(-DOXODSN, -DOXODN, -POTRAS, -PROD, -NEPROD, -USLUG, -NALOG, -OBPL, -RAVT, -CHLICN), factor)
  
```

ИЛИ

```{r}
ob_fct <-ob %>%
 mutate_at(vars(MEST, RPC, DOSINT, FINPOL), factor)
```

И теперь можно приступать к аостроению регрессии.
Начнём с парной и построим регрессию зависимости площади квартиры от дохода респондента.
Для этого воспользуемся командой `lm()` и передадим ей данные и формулу.

```{r}
model_r <- lm(data = ob_fct, OBPL ~ DOXODSN)
```

С помощью команды `summary()` посмотрим на описание модели.

```{r}
summary(model_r)
```

Построенная модель и коэффициент являются значимыми, однако коэффициент детерминации - очень низкий, что не позволяет говорить о построении оптимальной модели.

Другой способ посмотреть на описание модели — воспользоваться функциями пакета `broom`.
Оценки коэффциентов, стандартные ошибки, p-значения выводит команда `tidy()`:

```{r}
tidy(model_r)
```


А функция `glance()` покажет общие характеристики модели, для которых достаточно одной строчки, — коэффциент детерминации, значение лог-функции правдоподобия, AIC, BIC...

```{r}
glance(model_r)

```
Если из общей таблицы описания модели нужна только информация о коэффициентах, то поможет команда `coeftest()` из пакета `lmtest()`.

```{r}
coeftest(model_r)
```

Нарисуем линию регрессии для модели, в которой зависимая переменная — это OBPL, а объясняющая — DOXODSN.
Для этого к диаграмме рассеяния добавим дополнительный слой `geom_smooth()`.
Внутри него за линейную регрессию отвечает `method = 'lm'`.

```{r}
ggplot(data = ob_fct, aes(x = DOXODSN, y = OBPL)) +
  geom_point() +
  geom_smooth(method = 'loess')
```



Теперь оценим более сложную модель.
К объясняющим переменным добавим переменные - Потребительские расходы (POTRAS), Расходы на покупку продуктов питания (PROD), Расходы на оплату услуг (USLUG), Налиие автомобиля (RAVT) и Налоги, сборы, платежи (NALOG) .

```{r}
model_ur <- lm(data = ob_fct, OBPL ~ DOXODSN + POTRAS + PROD + USLUG + RAVT + NALOG)
summary(model_ur)
```

Построенная модель включает два незначимых коэффициента - Наличие машины и потребительские расходы. Исключим эти коэффициенты и построим модель со всеми значимыми коэффииентами с использованием пошаговых алгоритмов РА.


```{r}
model_ur <- lm(data = ob_fct, OBPL ~ DOXODSN + PROD + USLUG + RAVT + NALOG)
summary(model_ur)
```

```{r}
model_ur <- lm(data = ob_fct, OBPL ~ DOXODSN + PROD + USLUG + NALOG)
summary(model_ur)
```
Таким образом, посроена статистически значимая регрессионная модель со всеми значимыми коэффициентами.
Неожиданным является отрицательный знак при переменной Доход.Модель нуждается в дополнительной диагностике!


```{r}
ggnostic(model = model_ur)
```

На этом графике четыре линии!
* Первая: зависимость величины остатка $\hat u_i = y_i - \hat y_i$ от каждого регрессора.
* Вторая: зависимость величины $\hat \sigma_i$ от каждого регрессора.

Величина $\hat \sigma_i$ показывает, какой была бы оценка стандартного отклонения случайной составляющей,
если бы $i$-ое наблюдение выкинули из модели.

Слишком маленькие значения $\hat \sigma_i$ говорят о том, что
при выкидывании наблюдения резко падает оценка стандартного отклонения. Значит, наблюдение могло быть выбросом.

* Третья: зависимость величины $h_{ii}$ от каждого регрессора.

Величина $h_{ii}$ имеет две интерпретации. Во-первых, она показывает, насколько изменится прогноз $\hat y_i$ при увеличении фактического наблюдения $y_i$ на единицу.
Во-вторых, эта величина показывает отношение дисперсии прогноза $\hat y_i$ к дисперсии случайной составляющей:
\[
h_{ii} = \frac{Var(\hat y_i)}{Var(u_i)}
\]

* Четвертая: зависимость расстояния Кука от каждого из регрессоров.

Расстояние Кука показывает, насколько сильно изменятся прогнозы по всему набору данных, при выкидывании $i$-го наблюдения,


Построим 5\%-ые доверительные интервалы для всех коэффициентов модели `model_ur`.
Для этого будем использовать команду `confint()`.
Поменять уровень значимости можно аргументом `level`.
Затем визуилизируем получившиеся доверительные интервалы командой `sjp.lm()` из пакета `sjPlot`.

```{r}
coefci(model_ur, level = 0.95)
plot_model(model_ur, type='std', ci.lvl = 0.9)
```

Диагностика мультиколлинеарности. Коэффициенты вздутия дисперсии
```{r}
vif(model_ur)
```

Если есть две вложенных модели, то есть одна является частным случаем другой,
то можно провести тест Вальда, чтобы выбрать одну из них.

$H_0$: верна ограниченная (короткая) модель;

$H_1$: верная неограниченная (длинная) модель;

```{r}
waldtest(model_r, model_ur)
```

Сравнение p-значений позволяет сделать вывод, что длинаая модель дает прирост информативности, поэтому ее предпочтительнее использовать при моделировании OBPL (выбираем вторую модель).

# Регрессия при гетероскедастичных ошибках

Построим табличку с тестами на значимость отдельных коэффициентов с учётом поправки на гетероскедастичность.

```{r}
coeftest(model_ur, vcov. = vcovHC)
```

Рассмотрим доверительные интервалы:

```{r}
coefci(model_ur, vcov. = vcovHC)
```


Сравним две вложенных модели с учётом поправки на гетероскедастичность:
```{r}
waldtest(model_r, model_ur, vcov = vcovHC)
```

Результаты оценивания показыают, что вторая модель (с учётом поправки на гетероскедастичность), предпочтительнее.