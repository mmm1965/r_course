---
title: 'Семинар 6. Красотища'
date: 'Июнь, 18, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: journal-of-econometrics.csl
---



Шаманское заклинание для настройки глобальных опций отчёта:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Подключаем пакеты
```{r}
library(tidyverse) # обработка данных, графики...
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(broom) # метла превращает результаты оценивания моделей в таблички
library(GGally) # больше готовых графиков
library(sjPlot) # ещё больше графиков
library(lmtest) # диагностика линейных моделей
library(sjstats) # удобные мелкие функции для работы с моделями
library(sandwich) # оценка Var для гетероскедастичности
library(AER) # работа с инструментальными переменными
library(Ecdat) # много-много разных наборов данных
library(huxtable) # красивые таблички в html, tex
library(stargazer) # красивые таблички в html, tex
library(texreg) # и снова красивые таблички в html, tex :)
library(estimatr) # модели с робастными ошибками
```

Заметим, что в данном случае, важно, какой пакет подключать раньше, `AER`, или `Ecdat`.
Оба пакета содержат встроенный набор данных с названием `Mroz`, и эти наборы данных чуть-чуть отличаются.
По умолчанию, активен набор данных `Mroz` из последнего подключённого пакета.
Если нужен другой набор данных, то до него можно дотянуться, указав имя пакета в начале, `AER::Mroz`.


# Регрессия при гетероскедастичных ошибках

Если не предполагать, что дисперсии ошибок $Var(u_i)$ одинаковы для всех наблюдений,
то построенные нами доверительные интервалы и выполненная проверка гипотез — полный отстой :)

Есть два подхода работать с робастными стандартными ошибками.
Можно переоценить модель с помощью функций из пакета `estimatr`,
а можно использовать ранее оцененные модели, указывая каждый раз нужную оценку ковариационной матрицы.


Загружаем данные и объявляем переменные факторными:
```{r}
pulse <- import('data/pulse.txt')
pulse_fct <- pulse %>%
  mutate_at(vars(-Weight, -Height, -Age, -Pulse1, -Pulse2), factor)
```

Оценим модели без учёта гетероскедастичности:
```{r}
model_r <- lm(data = pulse_fct, Pulse2 ~ Pulse1)
model_ur <- lm(data = pulse_fct, Pulse2 ~ Weight + Pulse1 + Ran + Smokes)
```

Способ с переоцениванием модели:
```{r}
model_r_rob <- lm_robust(data = pulse_fct, Pulse2 ~ Pulse1)
model_ur_rob <- lm_robust(data = pulse_fct, Pulse2 ~ Weight + Pulse1 + Ran + Smokes)
```

Проверка гипотез и доверительные интервалы с робастно оценёнными моделями:
```{r}
coeftest(model_ur_rob)
coefci(model_ur_rob)
```

Сравнение двух робастно оценённых моделей:
```{r}
waldtest(model_r_rob, model_ur_rob)
```

Второй способ с использование опции и изначальными моделями, оценёнными без поправки на гетероскадастичность.
```{r}
coeftest(model_ur, vcov. = vcovHC)
coefci(model_ur, vcov. = vcovHC)
```

Результаты в R чуть отличаются от результатов в stata.
По-умолчанию, R использует корректировку HC3 для подсчёта стандартных ошибок коэффициентов, а stata — менее удачную, устаревшую HC1.
Сравнение есть у [Achim Zeileis](https://cran.r-project.org/web/packages/sandwich/vignettes/sandwich.pdf).
Если хочется воспроизвести именно корректировку HC1, то запросто :)

```{r}
coeftest(model_ur, vcov. = vcovHC(model_ur, type = "HC1"))
```

Сравним две исходных модели с учётом поправки на гетероскедастичность:
```{r}
waldtest(model_r, model_ur, vcov = vcovHC)
```

- Какая модель предпочтительнее?


* Упражнение 8.

Получите таблицу с тестами на значимость коэффициентов в модели `house_ur`,
используя корректировку `HC3`.
А затем сравните две модели `house_r` и `house_ur` с учётом поправки на гетероскедастичность.

```{r}
# coeftest(___, vcov. = ___, type = ____)
# waldtest(___, ___, vcov =  vcovHC)
```



# Инструментальные переменные


Исследователи всегда мечтают обнаружить не просто статистическую связь, а причинно-следственную.
Проще всего было бы обнаружить связь с помощью рандомизированного эксперимента:
поделить случайно индивидов случайно на две группы, одну попросить стирать обычным порошком,
а вторую — новым чудопорошком.
Важно упаковать порошки совершенно одинаково и говорить одни и те же слова :)

Мы часто имеем с данными наблюдений.
Рандомизированного эксперимента при этом не было.
В редких случаях можно попытаться обнаружить причинно-следственную связь на данных наблюдений.

Рассмотрим набор данных по предложению труда женщин `Mroz` из пакета `Ecdat`.

```{r}
glimpse(Mroz)
```

Отберём работавших женщин.
```{r}
labor <- filter(Mroz, wagew > 0)
```
Мы хотим оценить причинно-следственный эффект от дополнительного года обучения на заработную плату женщины.

На первый взгляд разумно попробовать обычный МНК:
```{r}
model_lm <- lm(data = labor, log(wagew) ~ educw + experience + I(experience^2))
summary(model_lm)
```

Эта регрессия прекрасно оценивает силу статистической взаимосвязи и показывает,
насколько различается зарплата двух женщин, у которых разное образование, и одинаковый опыт работы.

Эта регрессия вовсе не говорит, насколько увеличится зарплата данной женщины,
если она надумает ещё год поучиться.

Проблема состоит в ненаблюдаемых характеристиках, например, в способностях жещнины.
Логично предположить, что ненаблюдаемые способности связаны положительно и с зарплатой
и с продолжительностью обучения.

При всей спорности предположения, будем считать, что
\[
\log(wagew_i) = \beta_1 + \beta_2 educw_i + \beta_3 experience_i +
   \beta_4 experience_i^2 + \beta_5 ability_i + u_i,
\]
где ошибка $u_i$ некоррелирована с остальными переменными в правой части.


Предположим, что образование матери и отца, `educwm` и `educwf` не коррелированы с ошибкой $u_i$.
Тогда их можно использовать как инструменты для переменной `educw_i`.


В качестве инструментальных переменных для `educw` возьмём образование матери и отца, `educwm` и `educwf`:

```{r}
model_iv <- ivreg(data = labor,
  log(wagew) ~ educw + experience + I(experience^2) |
    experience + I(experience^2) + educwm + educwf)
summary(model_iv, diagnostics = TRUE)
```

После вертикальной палочки `|` в команде `ivreg` указывают экзогенные переменные,
используемые в качестве инструментов.

Если верить в то, что образование матери и отца некоррелировано с ненаблюдаемыми способностями женщины,
тогда коэффициент при образовании женщины `educw` показывает, насколько
изменится зарплата женщины при увеличении образования на один год, постоянном опыте и постоянных способностях.

Автоматически команда `summary` с опцией `diagonostics = TRUE` проводит три теста:

1. Тест на слабые инструменты

Нулевая гипотеза: $H_0$: инструментальные переменные не коррелированы с потенциально эндогенным регрессором

2. Тест Хаусмана на равенство оценок IV и обычного МНК.

Нулевая гипотеза: $H_0$: ковариация потенциально эндогенного регрессора с ошибкой равна нулю.

3. Тест Саргана

Нулевая гипотеза: $H_0$:  инструментальные переменные правильно подобраны, то есть
они не коррелированы с ошибкой, а невключённые инструменты и не должны быть включены в модель.

- Какие гипотезы отвергаются, какие не отвергаются в нашем случае?


Легко использовать IV с робастными к гетероскедастичности ошибками
```{r}
summary(model_iv, diagnostics = TRUE, vcov. = vcovHC)
```

Есть и отдельная функция в пакете `estimatr`:
```{r}
model_iv_robust <- iv_robust(data = labor,
  log(wagew) ~ educw + experience + I(experience^2) |
    experience + I(experience^2) + educwm + educwf)
summary(model_iv_robust)
```

* Упражнение 9.

Для упражнения возьмём данные о потреблении сигарет в США `CigaretteeSW` из
пакета `AER`.
Его описание можно прочесть в справке!

Возьмём наблюдения только за 1995 год и создадим несколько новых переменных:
логарифм реальных цен `lrprice`, логарифм дохода на душу населения `lrincome`,
логарифм количества пачек сигарет на человека `lquant` и реальный налог на
сигареты `tdiff`.

```{r}
data("CigarettesSW")
cig <- subset(CigarettesSW, year == 1995)
cig$lrprice <- log(cig$price / cig$cpi)
cig$lrincome <- log(cig$income / cig$population / cig$cpi)
cig$lquant <- log(cig$packs)
cig$tdiff <- (cig$taxs - cig$tax) / cig$cpi

# glimpse(___)
# skim(___)
```

Постройте регрессию логарифма количества пачек сигарет на человека `lquant`
на логарифм реальной цены одной пачки `lrprice`, используя в качестве инстурмента
реальный налог `tdiff`.

```{r}
# cig_iv1 <- ivreg(data = ___, ___ ~ ___ | ___)
# summary(___, diagnostics = ___)
```

Добавьте к объясняющим переменным логарифм реального дохода на душу населения
`lrincome`, а к инструментам — реальный налог на сигареты `tax / cpi`.

```{r}
# cig_iv2 <- ivreg(data = ___, ___ ~ ___ + ___ | ____ + ___ + I(tax/cpi))
# summary(___, ___ = ___)
```

Мы доносим информацию до читателя в графиках, таблицах и тексте.

R позволяет создавать документы в совершенно разных форматах, мы познакомимся с тремя: html, docx, tex.




# Формат html

Прелесть html состоит в богатстве оформления и динамических элементах.

Начнём с нескольких таблиц.

Составим по-быстрому табличку описательных статистик:
```{r, results='asis'}
skim_to_wide(diamonds) %>%
  filter(type != 'factor') %>%
  select(variable, complete, mean, sd, p0, p50, hist) %>%
  hux(add_colnames = TRUE) %>% print_html()
```

Оформляем наши таблички симпатичнее:
```{r, results='asis'}
htmlreg(list(model_r, model_ur, model_r_rob, model_ur_rob),
        include.ci = FALSE,
        star.symbol = '\\*')
```

Вариант с доверительными интервалами:
```{r, results='asis'}
htmlreg(list(model_r, model_ur, model_r_rob, model_ur_rob), ci.force = TRUE)
```



Просто картинка в html с подписями и ссылкой:
```{r, fig.width=3, fig.height=4}
ggplot(data = pulse_fct, aes(x = Pulse1, y = Pulse2)) +
  geom_point() +
  geom_smooth(method = 'lm') + labs(x = 'Пульс до (уд/мин)', y = 'Пульс после (уд/мин)')
```

Для примера процитируем несколько источников,
@afanasyev92, @cobb2011teaching, @microsoftProject2008, @doe:website.

Другие стилевые заготовки для оформления цитат можно скачать в архиве [zotero](https://www.zotero.org/styles).


Примеры таблиц для html с [пакетом huxtable](https://hughjonesd.github.io/huxtable/), интерактивные элементы, например, карты, с [htmlwidgets](http://gallery.htmlwidgets.org).


И библиографию в студию:
