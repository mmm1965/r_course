---
title: 'Описательный анализ данных'
date: 'July 3-4, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---


Подключаем нужные пакеты 
```{r, echo=FALSE, message=FALSE}
library(tidyverse) # обработка данных, графики...
library(vcd) # мозаичные графики для качественных переменных
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(ggalluvial) # потоковые ???? графики для качественных переменных
library(nycflights13) # набор данных о вылетах из Нью-Йорка
library(corrplot) # визуализация корреляций
library(reshape2) # длинные и широкие таблицы
library(tidyverse) # обработка данных, графики...
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(ISLR) # ещё данные
library(caret) # пакет для подбора параметров разных моделей
library(FFTrees) # быстрые деревья
library(margins) # для подсчёта предельных эффектов
library(rpart.plot) # для картинок деревьев
library(plotROC) # визуализация ROC-кривой
library(ggeffects) # графики для предельных эффектов
library(MLmetrics) # метрики качества
library(ranger) # случайный лес
library(factoextra) # графики для кластеризации и pca
library(elasticnet) # LASSO
library(latex2exp) # формулы в подписях к графику
library(distances) # расчет различных расстояний
library(ggalluvial)# потоковые диаграммы для качественных переменных
library(corrplot) # визуализация корреляций
library(reshape2) # длинные и широкие таблицы
library(vcd) # мозаичные графики для качественных переменных
library(lattice)
library(DataExplorer)
library(lattice)
library(cluster) # кластерный анализ
library(factoextra) # визуализации kmeans, pca,
library(dendextend) # визуализация дендрограмм
library(corrplot) # визуализация корреляций
library(naniar) # визуализация пропущенных значений
library(visdat) # визуализация пропущенных значений
library(patchwork) # удобное расположение графиков рядом

```

Для выполнения задания загружаем файл obsl и сохранен в переменной под названием `ob`.

Для этого воспользовались функцией `import` из пакета `rio`.
Затем проверим, что данные загрузились с помощью команд `glimpse`, `head` и `tail`.
```{r}
ob <- import('C:/Users/ASUS/Desktop/r_course/data/obsl.sav')
glimpse(ob)
head(ob)
tail(ob)

```

Переменные
			
1	MEST	Тип населенного пункта (1-городской, 2- сельский) -	качественная
2	CHLICN	Число наличных лиц в домохозяйстве -	количественная
3	DOXODSN	Денежный доход	 - количественная
4	DOXODN	Среднедушевой доход	- количественная
5	POTRAS	Потребительские расходы	 - количественная
6	PROD	Расходы на покупку продуктов питания -	количественная
7	NEPROD	Непродовольственные расходы	 - количественная
8	USLUG	Расходы на оплату услуг	- количественная
9	NALOG	Налоги, сборы, платежи -	количественная
10	OBPL	Общая площадь квартиры	- количественная
11	RPC	Наличие персонального компьютера (1-да, 0 – нет) -	качественная
12	RAVT	Наличие автомобиля 	 - количественная
13	DOSINT	Доступ в интернет (1-да, 2-нет)	 - качественная
14	FINPOL	Финансовое положение  (-7 – затрудняюсь ответить, 1- не хватает на еду, 2 – на еду хватает, но на одежду нет, 3 – на еду и одежду хватает, но не хватает на оплату коммунальных платежей, 4- можем позволить все необходимое, 5 – средств достаточно)	- Порядковая (качественная)

Целевая переменная — Наличие доступа в Интернет, `DOSINT`, принимает два значения, '1' (да), '2' (нет).
Переменная FINPOL имеет 6 градации (-7 – затрудняюсь ответить, 1- не хватает на еду, 2 – на еду хватает, но на одежду нет, 3 – на еду и одежду хватает, но не хватает на оплату коммунальных платежей, 4- можем позволить все необходимое, 5 – средств достаточно)

В используемых данных пропущенные переменных нет

В наборе данных содержатся переменные различных типов: количественные, порядковые, фиктивные, принимающие два значения (да,нет)

Для изучения описательных статистик переменных воспользуеимся функцией `skim()` из пакета `skimr()`.

```{r}
skim(ob)
```
Увидим и проанализируем основыне характеристики используемых показателей (среднее значение, СКО, а также квартили)

Отдельно выведем информацию о порядковой пеерменной Финансовое положение

```{r}
levels(ob$FINPOL)
```
Переменная FINPOL имеет 6 градаций


4. Построим гистограммы для качественных переменных FINPOL (Финансовое положение) и Наличие доступа в Интернет (DOSINT). 
Для этого воспользуеися командой `qplot`.

```{r}
qplot(data = ob, x = FINPOL) +
labs(x ='Финансовое положение', y ='Количество', title = 'Распределение респондентов по финансовому положению')
```



```{r}
qplot(data = ob, x = DOSINT ) +
labs(x ='Наличие доступа в интернет ', y ='Количество', title = 'Распределение респондентов по доступу в интернет')
```

```{r}
ggplot(data = ob) + 
  geom_histogram(aes(x = DOXODSN )) + 
  facet_grid(FINPOL ~ .) +
  labs(x = 'Финансовое положение респондента', title = 'Гистограмма')

```

Построим диаграммы рассеяния для количественных переменных `DOXODSN` (по оси абсцисс) и `NALOG` (по оси ординат) c помощью команды `qplot`  


```{r}
qplot(data = ob, x = DOXODSN, y = NALOG) +
labs(x ='Денежный доход', y = 'Налоги', title = 'поле корреляции для доходов и налогов' )
```

Посмотрим гаграмму рассеяния для количественных переменных  Располагаемые ресурсы  (RASRESS) и Общая площадь квартиры (OBPL).


```{r}
qplot(data = ob, x =DOXODSN, y = OBPL ) +
labs(x ='Денежный доход ', y ='Количество', title = 'Распределение респондентов по площади квартиры')
```

Построим поле корреляции для пеерменных Доход и Площадь квартиры.
Добавим цвет и вертикальную и горизонтальную линию, позволяющие получить среднее значение анализируемых показателей, а также цветовую политру в зависимости от оценки своего финансового положения.
```{r}
skim(ob)

ggplot(data = ob) + 
  geom_point(aes(x = DOXODSN, y = OBPL, col = FINPOL)) + 
  geom_vline(aes(xintercept = mean(DOXODSN)), linetype = 'dashed') +
  geom_hline(aes(yintercept = mean(OBPL)), linetype = 'dashed') +
  labs(x = 'Доход респондента', y = 'Площадь квартиры', title = 'Диаграмма рассеяния')
```

Диаграмма рассеяния показывает, что между переменная Располагаемые ресурсы и Площадь квартиры связь слабая (преимущественно точки вытянуты вдоль оси ординат). Это не ожидаемый результат, однако он может быть объяснен тем, что некоторые респонденты получили квартиру благодаря подарку родителей (или по наследству). При этом имеются ярко выраженные аномальные наблюдения (выбросы).  

Посмотрим наличие аномальных наблюдений с использованием скрипичного графика (команда geom_viloin() из пакета ggplot2)

```{r}
ob <- mutate(ob, FINPOL = factor(FINPOL))
ggplot(data = ob, aes(x=FINPOL, y=OBPL))+
  geom_violin() +
labs(x ='Финансовое положение респондента', y = 'Общая площадь квартиры', title = 'Площадь квартиры' )
```
Добавим цвета

```{r}
ggplot(data = ob) + 
  geom_violin(aes(x = FINPOL, y = OBPL, fill = FINPOL)) + 
  labs(x = 'Финансовое положение', y = 'Общая площадь квартиры', title = 'Скрипичный график')
```

Анализ рисунка позволяет увидеть, что наибольший разброс в площади квартиры наблюдается у респондентов, которые, характеризуя свое финансовое положение назвали код 3 – "на еду и одежду хватает, но не хватает на оплату коммунальных платежей ли 4- "можем позволить все необходимое". Т.е это две самые обеспеченные группы респондентов, отсюда - выбросы в строну квартир, имеющих большую площадь. Что касается респондентов, которые указали код 1 (не хватает на еду), то площадь их квартир довольно однородная.


```{r}
ggplot(data = ob) + 
  geom_violin(aes(x = FINPOL, y = DOXODSN, fill = FINPOL)) + 
  labs(x = 'Финансовое положение', y = 'Доход респондента', title = 'Скрипичный график')
```

Самый высокий разброс у респондентов, назвавших код 4(можем позволить все необходимое)


Посмотрим частость каждой категории

```{r}
table(ob$FINPOL)
```

Мы видим, что больше всего респондентов, указавших при ответе коды 3 и 4, меньше всего - коды 1 и 5. 

Объединим респондентов, назвавших коды 1,2, И 5 В КАТЕГОРИЮ "ПЛОХО ОБОСПЕЧЕННЫE" и сохраним результат в переменной ob2

Получим, что в категорию "ПЛОХО ОБОСПЕЧЕННЫE" попало 219 респондентов.

Для изучения закона распределения пеерменной РАСПОЛПГПЕМЫЙ ДОХОД построим гистограмму для перменной hist DOXODSN


```{r}
hist(ob$DOXODSN)
```
Денежная переменная имеет ярко выраженную правуостороннюю ассиметрию. Пролагарифмируем ее и построим гистограмму логарифмически нормального закона распределения

Изучим связь между интересующими нас переменными с помощью построения корреляционной матрицы по первым 1000 наблюдениям

```{r}
splom(ob[1:1000, c('DOXODSN', 'PROD', 'NALOG')])
```

Таким образом, построение полей корреляции показало наличие связи между показателями Располагаемые ресурсы и площадь квартиры (имеются выбросы, которые несколько искажают изучение связи между пеерменными).

Отсортируем респондентов по среднедушевому доходу и посмотрим на первые и последние наблюдения.


```{r}
sorted <- arrange(ob, DOXODN)
sorted
```

Посмотрим на выбросы с помощью построения  скрипичного графика (команда geom_viloin() из пакета ggplot2)


Добавим цвет и построим поле корреляции для пеерменных Доход и Площадь квартиры с учетом пеерменной Финансовое положение (удовлетворенность жинью).


```{r}
ob3 <- mutate(ob, Exp = factor(FINPOL))

ggplot(data = ob3) +
  geom_point(aes(x = DOXODSN, y = OBPL, color = Exp)) +
  scale_x_log10() + 
  scale_y_log10() + 
  labs(x = 'Логарифм дохода', y = 'площадь квартиры', title = 'Удовлетворенность жизнью')
```
Анализ рисунка позврляет увидеть, что респонденты, доаольные своим материальным положеним (4- можем позволить все необходимое), в основном, имеют высокий доход, однако площадь их квартиры довольно неоднородна. Т.е респонденты с высокими доходами и могующие себе все позволить зачастую имеют небольшие по площади квартиты.

Посмотрим частость каждой категории
```{r}
table(ob$FINPOL)
```
Мы видим, что больше всего респондентов, указавших при ответе коды 3 и 4, меньше всего - коды 1 и 5. 

Объединим респондентов, назвавших коды 1,2, И 5 В КАТЕГОРИЮ "ПЛОХО ОБОСПЕЧЕННЫE" и сохраним результат в переменной ob2

Получим, что в категорию "ПЛОХО ОБОСПЕЧЕННЫE" попало 219 респондентов.

Построим рис без логарифмирования перемнных

```{r}
ob3 <- mutate(ob, Exp = factor(FINPOL))

ggplot(data = ob3) +
  geom_point(aes(x = DOXODSN, y = OBPL, color = Exp)) +
  labs(x = 'Логарифм дохода', y = 'площади квартиры', title = 'Удовлетворенность жизнью')

```

Увидим более четкие выбросы для респондентов, назвавших коды 3 и 4. Они имеют более высокие доходы и плащадь квартиры.
Построим гистограмму логарифма дохода для каждой категории Финансового положения.

```{r}
ggplot(data = ob3) +
  geom_histogram(aes(x = log(DOXODSN))) +
  facet_grid(FINPOL ~ .) +
  labs(x = 'Логарифм дохода', title = 'Удовлетворенность жизнью')
```
Построим гистограмму логарифма площади квартиры для каждой категории Финансового положения.
```{r}
ggplot(data = ob3) +
  geom_histogram(aes(x = log(DOXODSN))) +
  labs(x = 'Логарифм дохода', y = 'Количество', title = 'Удовлетворенность жизнью')

```

```{r}
skim(ob3)

ggplot(data = ob3 ) + 
  geom_histogram(aes(x = DOXODSN)) + 
  facet_grid(FINPOL ~ .) +
  labs(x = 'ВВП', title = 'Гистограмма')

```


```{r}
ggplot(data = ob3) +
  geom_histogram(aes(x = log(OBPL))) +
  facet_grid(FINPOL ~ .) +
  labs(x = 'Логарифм дохода', title = 'Удовлетворенность жизнью')

```

Таким образом, описательный анализ данных позволил увидеть распределение и основные характеристики отобоанных показателей, изучить их связи.
:)
